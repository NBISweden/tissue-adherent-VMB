---
title: "`r params$project_title`"
editor_options:
  chunk_output_type: console
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  #pdf_document:
    #toc: yes
  html_document:
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
params:
  dataset: 1
---

```{r Setup, echo = FALSE}
knitr::opts_chunk$set(fig.width  = 10,
                      results    = "hold",
                      message    = FALSE,
                      warning    = FALSE)
```

#Load libraries and other scripts

```{r, echo = FALSE}
library(igraph)
library(rafalib)
library(sva)
library(batchelor)
library(scales)
remotes::install_github("czarnewski/niceRplots",upgrade = "always",force = T)
library(niceRplots)

```

#Defining some variables for the analysis

```{r, echo = FALSE}
PATH <- "~/Desktop/NBIS/SMS_Projects/broliden_5325" #Path to the data
PATH <- "../.." #Path to the data

#color palettes
pal <- c(RColorBrewer::brewer.pal(9,"Set1"),RColorBrewer::brewer.pal(8,"Set2"),
         RColorBrewer::brewer.pal(9,"Pastel1"),RColorBrewer::brewer.pal(8,"Pastel2")) #color pallete for plots
heat_pal <- c("#000000", colorRampPalette(c("#000000","grey5","grey30","orange3","yellow","yellow","white"))(90))
cor_pal <- colorRampPalette(c("navy","white","firebrick"))(90)


#Graph construction  
k <- 10 # k for KNN
P <- 0.35 # prunning threshold of SNN


#Graph construction  
fct <- .25 # FC threshold for differential expression
pvt <- 0.05 # Pvalue threshold for differential expression
min_pct <- .1 # minimun level of detected bacteria in each sample group
```

# Loading data and metadata

```{r, echo = FALSE}
# Load metadata
metadata <- read.csv(paste0(PATH,"/data/Clinical_visit_2_3_updatesept28.csv"))
rownames(metadata) <- as.character(metadata$ID)

# Load datasets
dataset_names <- c("ASV_tissue_V3_normalized_batch_corrected.csv",
                   "ASV_CVL_V3_normalized_batch_corrected.csv",
                   "ASV_CVL_V2_normalized_batch_corrected.csv",
                   "ASV_CVL_V2_normalized_NOT_batch_corrected.csv")

#import datasets and return matrix with taxa-level resolution
datasets <- lapply(dataset_names, function(x){
  x <- read.csv( paste0(PATH,"/results/",x),row.names = 1)
  return(x)
})
names(datasets) <- dataset_names
lapply(datasets,dim)
```


# Merging microbiome datasets

```{r, echo = FALSE}
# Define the common microbes
common_microbes <- sort(unique(unlist(lapply(datasets,rownames))))
sample_names <- sort(unique(unlist(lapply(datasets,colnames))))

# Create empty matrix for the full dataset
microbiome <- as.matrix(datasets[[ params$dataset ]])
microbiome <- microbiome[ rowSums(microbiome>0)>=2 , colSums(microbiome>0)>=2 ]
  
dataset_origin <- factor(rep(sub("_norma.*","",names(datasets)[2]),ncol(datasets[[2]])))
```


# Organise the datasets

```{r, echo = FALSE}
zscore <- t(apply(microbiome,1,function(i){scale(i,T,T)}))
zscore[ zscore > 6 ] <- 6
zscore[ zscore < -6 ] <- -6
rownames(zscore) <- rownames(microbiome); colnames(zscore) <- colnames(microbiome)

eucl <- as.matrix(dist(t(zscore),method = "euclidean"))
h_bacs <- hclust(dist(zscore),method = "ward.D2")
h_samples <- hclust(dist(t(zscore)),method = "ward.D2")

microbiome <- microbiome[h_bacs$order,h_samples$order]
zscore <- zscore[h_bacs$order,h_samples$order]
```


# Organise the datasets

```{r, echo = FALSE,fig.width  = 10, fig.height=6}
mypar(1,2,mar=c(2,2,2,5))
image(t(microbiome[nrow(microbiome):1,]),
      col=heat_pal,
      axes=F,main="log2(CP1K+1)",
      xlab="samples",ylab="bacteria",
      line=.4,cex.main=1,font.main=1)
text(  1+.02 ,seq(1,0,length.out = nrow(zscore)) , labels = rownames(zscore), srt = 0, adj = c(0,.5), xpd = TRUE, cex=.4)

image(t(zscore[nrow(zscore):1,]),
      col=heat_pal,
      axes=F,main="Z-score log2(CP1K+1)",
      xlab="samples",ylab="bacteria",
      line=.4,cex.main=1,font.main=1)
text(  1+.02 ,seq(1,0,length.out = nrow(zscore)) , labels = rownames(zscore), srt = 0, adj = c(0,.5), xpd = TRUE, cex=.4)
```

\clearpage

# Computing a SNN graph from sample correlations

```{r, echo = FALSE}
mypar(2,2)

#Compute sample-wise correlations
cors <- cor(zscore,method = "pearson")
eucl <- as.matrix(dist(t(zscore)))
mean_local <- quantile(eucl,probs = .9)
hist(eucl,breaks = seq(min(eucl),max(eucl),length.out = 50),
     border=NA,col="grey60",las=1,
     xaxs="i",yaxs="i",
     main="euclidean distance",xlim=c(min(eucl),max(eucl)))
abline(v=median(eucl),col="red",lty=1,xpd=F)
abline(v=mean_local,col="red",lty=2,xpd=F)

#Compute KNN graph from correlation matrix
knn <- RANN::nn2(cors,k = k)
# knn <- RANN::nn2(t(zscore),k = k)
nn <- matrix(0, nrow(knn$nn.idx), nrow(knn$nn.idx))
for(idx in 1:nrow(knn$nn.idx) ){  nn[idx,knn$nn.idx[idx,]] <- 1 }

#Compute SNN graph from KNN
jSNN <- t( t( (nn %*% nn ) / rowSums(nn)) / colSums(nn))

#Prune SNN graph based on the Jaccard index
pSNN <- jSNN
pSNN <- pSNN / max(pSNN)

hist(pSNN[pSNN>0],breaks = seq(0,1,length.out = 50),
     border=NA,col="grey60",las=1,
     xaxs="i",yaxs="i",
     main="SNN jaccard",xlim=c(0,1))
abline(v=P,col="red",lty=2,xpd=F)

hist(cors[pSNN>0],breaks = seq(-1,1,length.out = 50),
     border=NA,col="grey60",las=1,
     xaxs="i",yaxs="i",
     main="correlation coeficient",xlim=c(-1,1))
abline(v=0,col="red",lty=1,xpd=F)

pSNN[ pSNN < P ] <- 0
pSNN[ pSNN > P ] <- cors[pSNN > P]
pSNN[ pSNN < 0 ] <- 0

g <- graph_from_adjacency_matrix(pSNN,mode = "undirected",diag = F,weighted = T)

```

\clearpage

# Visualise the data

```{r, echo = FALSE,fig.width  = 10, fig.height=3}
mypar(2,2,mar=c(0,0,2,10))

set.seed(1)
# l <- layout_with_graphopt(g,niter = 1000)
l <- layout_with_fr(g,niter=3000,start.temp=30)

cl <- igraph::cluster_louvain(g)

plot( g , vertex.label.cex=0.000001 , vertex.color = pal[factor(cl$membership)] , 
      edge.width=  ( E(g)$weight / max(E(g)$weight)) ,layout=l,
      vertex.size=10,
      edge.color=colorRampPalette(c("grey95","black"))(90) [ round( E(g)$weight / max(E(g)$weight) * 88 )+1 ] )
legend(x = par("usr")[c(2)]+.2*diff(par("usr")[c(1,2)]),
       y = par("usr")[c(4)],
       legend = levels(factor(cl$membership)),
       bty = "n",pch = 21,pt.bg = pal,pt.cex = 1,xpd=T)
title("Louvain clusters",cex.main=1,font.main=1)

plot( g , vertex.label.cex=0.000001 , vertex.color = pal[dataset_origin] , 
      edge.width=  ( E(g)$weight / max(E(g)$weight)) ,layout=l,
      vertex.size=10,
      edge.color=colorRampPalette(c("grey95","black"))(90) [ round( E(g)$weight / max(E(g)$weight) * 88 )+1 ] )
legend(x = par("usr")[c(2)]+.2*diff(par("usr")[c(1,2)]),
       y = par("usr")[c(4)],
       legend = levels(dataset_origin),
       bty = "n",pch = 21,pt.bg = pal,pt.cex = 1,xpd=T)
title("dataset",cex.main=1,font.main=1)


# plot( g , vertex.label.cex=0.000001 , 
#       vertex.color = hue_pal()(20)[factor(metadata[common_samples,"group_M9_CVLv3"])] ,
#       edge.width=  ( E(g)$weight / max(E(g)$weight)) ,layout=l,
#       vertex.size=10,
#       edge.color=colorRampPalette(c("grey95","black"))(90) [ round( E(g)$weight / max(E(g)$weight) * 88 )+1 ] )
# legend(x = par("usr")[c(2)]+.2*diff(par("usr")[c(1,2)]),
#        y = par("usr")[c(4)],
#        legend = levels(factor(metadata[common_samples,"group_M9_CVLv3"])),
#        bty = "n",pch = 21,pt.bg = hue_pal()(20),pt.cex = 1,xpd=T)
# title("group_M9_CVLv3",cex.main=1,font.main=1)

```


\clearpage


# Computing differential expression across clusters

```{r, echo = FALSE}

NN <- min(table(cl$membership))

res <- data.frame( matrix(0,nrow = 1,ncol = 6) )
for(i in unique(cl$membership)){
  for(j in rownames(microbiome) ){
    
    set.seed(1)
    a <- c(sample(microbiome[j,cl$membership == i],NN))
    set.seed(1)
    b <- sample(microbiome[j,cl$membership != i],NN)
    
    perc1 <- sum(microbiome[j,cl$membership == i]>0) / sum(cl$membership == i)
    perc2 <- sum(microbiome[j,cl$membership != i]>0) / sum(cl$membership != i)
    
    temp <- wilcox.test(x=a, y=b)
    
    fc <- log2( (mean(a)+1e-3) / (mean(b)+1e-3) )
    
    res <- rbind(res, setNames(c(j,i,fc,perc1,perc2,unlist(temp)[2] ),
                          c("bacteria","cluster","fc","perc.1","perc.2","pvalue")) )
    colnames(res) <- c("bacteria","cluster","fc","perc.1","perc.2","pvalue")
  }
}
res <- res[-1,]
res$pvalue <- as.numeric(res$pvalue)
res$perc.1 <- as.numeric(res$perc.1)
res$perc.2 <- as.numeric(res$perc.2)
res$perc.diff <- res$perc.1 - res$perc.2

res$fc <- as.numeric(res$fc)
res$FDR <- p.adjust(res$pvalue)
res <- res[order(res$pvalue),]
res <- res[abs(res$fc) > fct,]
res <- res[abs(res$pvalue) < pvt,]
res <- res[ (res$perc.1 > min_pct) | (res$perc.2 > min_pct) ,]
dim(res)
```


#Plotting the most significant bacteria across clusters


```{r, echo = FALSE, fig.width  = 10, fig.height=14}
library(dplyr)
res %>% group_by(cluster)  %>% top_n(-20, pvalue) %>% top_n(10, fc) -> top7
top7 <- top7[top7$fc > 0 , ]

groupings <- factor(cl$membership)
ord <- factor(sapply(unique(as.character(res$bacteria)),function(x){getcluster(microbiome, x, groupings)}))


mypar(2,2,mar=c(2,15,1,1))

plot_dots(microbiome, names(sort(ord)) ,
          clustering = cl$membership,
          show_grid = T,cex.main=1,font.main=1,
          cex.row = .8,cex.col = .8,srt = 0)

barlist( microbiome , names(sort(ord)), clustering = cl$membership, col=pal,cex.axis = .8)

violist( microbiome , names(sort(ord)), clustering = cl$membership,cex.axis = .8,
         col=pal,smooth = 2,transparency = 60,pt.col = "black")


o <- order(cl$membership)
image(t(zscore[rev(names(sort(ord))),o]),col=heat_pal,axes=F,border=NA,
      main="",xlab="",ylab="samples",line=.4,cex.main=1,font.main=1)
text(  rep(par("usr")[c(1)]-.01*diff(par("usr")[c(1,2)])) , seq(1,0,length.out = length(names(sort(ord)))),
      labels = names(sort(ord)), srt = 0, adj = c(1,.5), xpd = TRUE, cex=.8)
points( (0:(length(cl$membership)-1) )/(length(cl$membership)-1),
        rep(par("usr")[c(3)]-.01*diff(par("usr")[c(3,4)]),length(cl$membership)), pch=16,
        col=pal[factor(cl$membership)][o] ,xpd=T)

```

#Plotting the most significant bacteria across PREVIOUS ANNOTATION


```{r, echo = FALSE, fig.width  = 10, fig.height=11}
mypar(2,2,mar=c(2,15,1,1))

common_samples <- colnames(microbiome)[colnames(microbiome) %in% metadata$ID]

plot_dots(microbiome[,common_samples], names(sort(ord)) ,cex.row = .8,cex.col = .8,
          clustering = factor(metadata[common_samples,"group_M9_CVLv3"]),
          show_grid = T,cex.main=1,font.main=1,
          srt = 90)

barlist( microbiome[,common_samples] , names(sort(ord)),cex.axis = .8,
         clustering = factor(metadata[common_samples,"group_M9_CVLv3"]),
         col=hue_pal()(20),srt = 90)

violist( microbiome[,common_samples] , names(sort(ord)), 
         clustering = factor(metadata[common_samples,"group_M9_CVLv3"]),cex.axis = .8,
         col=hue_pal()(20),smooth = 2,transparency = 60,pt.col = "black",srt = 45)


o <- order(factor(metadata[common_samples,"group_M9_CVLv3"]))
image(t(zscore[rev(names(sort(ord))),o]),col=heat_pal,axes=F,border=NA,
      main="",xlab="",ylab="samples",line=.4,cex.main=1,font.main=1)
text(  rep(par("usr")[c(1)]-.01*diff(par("usr")[c(1,2)])) , seq(1,0,length.out = length(names(sort(ord)))),
      labels = names(sort(ord)), srt = 0, adj = c(1,.5), xpd = TRUE, cex=.8)
points( (0:(length(factor(metadata[common_samples,"group_M9_CVLv3"]))-1) )/(length(factor(metadata[common_samples,"group_M9_CVLv3"]))-1),
        rep(par("usr")[c(3)]-.01*diff(par("usr")[c(3,4)]),length(factor(metadata[common_samples,"group_M9_CVLv3"]))), pch=16,
        col=hue_pal()(20)[factor(metadata[common_samples,"group_M9_CVLv3"])][o] ,xpd=T)

```


\clearpage

# Plotting the most significant bacteria across clusters

```{r, echo = FALSE, fig.width  = 10, fig.height=11}
mypar(6,6,mar=c(.5,.5,2,.5))

plot( g , vertex.label.cex=0.000001 , vertex.color = pal[factor(cl$membership)] ,
      edge.width=  ( E(g)$weight / max(E(g)$weight)) ,layout=l,
      vertex.size=10,
      edge.color=colorRampPalette(c("grey95","black"))(90) [ round( E(g)$weight / max(E(g)$weight) * 88 )+1 ] )
empty_plot()
legend("topleft",legend = levels(factor(cl$membership)),bty = "n",pch = 21,pt.bg = pal,pt.cex = .8)


# plot( l , bg=pal[factor(cl$membership)],
#       pch=21,main="clusters",cex.main=1,font.main=1,
#       frame=F,axes=F,cex=1,xlab="",ylab="")
# empty_plot()
# legend("topleft",legend = levels(factor(cl$membership)),bty = "n",pch = 21,pt.bg = pal)


res2 <- res[order(res$cluster),]
for( j in 1:nrow(res2) ){
  i <- res2$bacteria[j]
  temp <- microbiome[i,]
  temp <- temp / max(temp)
  o <- order(temp)
  plot( l[o,] , col=c("grey85", colorRampPalette(c("grey80","grey60","navy"))(50)) [temp[o]*49+1],
        pch=16,main=paste0(i,"\ncluster=",res2$cluster[j]," (",ifelse(res2$fc[j]>0,"up)","down)")),
        cex.main=1,font.main=1,frame=F,axes=F,cex=1,xlab="",ylab="")
}
```


\clearpage


#Plotting bacteria across clusters

```{r, echo = FALSE, fig.width  = 10, fig.height=6}
mypar(2,2,mar=c(12,6,2,2))
o <- order(cl$membership)
image(zscore[rev(names(sort(ord))),o][,ncol(zscore):1],col=heat_pal,axes=F,border=NA,
      main="bacteria",xlab="",ylab="samples",line=.4,cex.main=1,font.main=1)
text( seq(1,0,length.out = length(names(sort(ord)))) ,
      par("usr")[c(3)]-.01*diff(par("usr")[c(3,4)]) , 
      labels = names(sort(ord)), srt = 60, adj = c(1,.5), xpd = TRUE, cex=.7)
points( rep(par("usr")[c(1)]-.01*diff(par("usr")[c(1,2)]),length(cl$membership)), pch=16,
    rev((0:(length(cl$membership)-1) )/(length(cl$membership)-1)),
    col=pal[factor(cl$membership)][o] ,xpd=T)

par("usr")[c(3)]-.01*diff(par("usr")[c(3,4)])


image(t(cors[o,o][nrow(cors):1,]),col=cor_pal,axes=F,border=NA,
      main="sample correlation matrix",xlab="samples",ylab="samples",line=.4,cex.main=1,font.main=1)
points( (0:(length(cl$membership)-1) )/(length(cl$membership)-1),
        rep(par("usr")[c(3)]-.01*diff(par("usr")[c(3,4)]),length(cl$membership)), pch=16,
        col=pal[factor(cl$membership)][o] ,xpd=T)
points( rep(par("usr")[c(1)]-.01*diff(par("usr")[c(1,2)]),length(cl$membership)), pch=16,
    rev((0:(length(cl$membership)-1) )/(length(cl$membership)-1)),
    col=pal[factor(cl$membership)][o] ,xpd=T)
```


\clearpage


#Plotting bacteria across clusters


```{r, echo = FALSE, fig.width  = 10, fig.height=6}
mypar(2,2)
barlist( rbind( BacsDetected = colSums(microbiome > 0) ,
                TotalCounts = colSums(microbiome),
                CountsPerBac = colSums(microbiome)/colSums(microbiome > 0) )
         , c("BacsDetected","TotalCounts","CountsPerBac"),
         clustering = metadata[colnames(microbiome),"group_M4_CVLv3"],
         col=pal)

violist( rbind( BacsDetected = colSums(microbiome > 0) ,
                TotalCounts = colSums(microbiome),
                CountsPerBac = colSums(microbiome)/colSums(microbiome > 0) )
         , c("BacsDetected","TotalCounts","CountsPerBac"),
         clustering = metadata[colnames(microbiome),"group_M4_CVLv3"],
         col=pal,transparency = 50,pt.col = "black",smooth = 2)


barlist( rbind( BacsDetected = colSums(microbiome > 0) ,
                TotalCounts = colSums(microbiome),
                CountsPerBac = colSums(microbiome)/colSums(microbiome > 0) )
         , c("BacsDetected","TotalCounts","CountsPerBac"),
         clustering = cl$membership,
         col=pal)

violist( rbind( BacsDetected = colSums(microbiome > 0) ,
                TotalCounts = colSums(microbiome),
                CountsPerBac = colSums(microbiome)/colSums(microbiome > 0) )
         , c("BacsDetected","TotalCounts","CountsPerBac"),
         clustering = cl$membership,
         col=pal,transparency = 50,pt.col = "black",smooth = 2)


table(list(cl$membership,metadata[colnames(microbiome),"group_M4_CVLv3"]))
```

\clearpage

# Saving clusters and differentially expressed bacteria

```{r, eval=T,echo = FALSE}
write.csv2( data.frame(cl$membership,row.names = colnames(microbiome)) ,row.names = T,
            paste0(PATH,"/results/Sample_Louvain_clusters_",params$dataset) )

write.csv2( data.frame(l,row.names = colnames(microbiome)) ,row.names = T,
            paste0(PATH,"/results/Sample_graph_layout_",params$dataset) )

write.csv2( res ,
            paste0(PATH,"/results/DGE_",params$dataset),row.names = T )
```

